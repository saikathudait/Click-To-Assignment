<!-- templates/marketing/all_projects.html -->
{% extends 'base.html' %}

{% block title %}All Projects{% endblock %}

{% block extra_css %}
<style>
.generation-overlay {
    position: fixed;
    inset: 0;
    background: rgba(5, 5, 5, 0.85);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2050;
}
.generation-overlay.active {
    display: flex;
}
.generation-modal {
    background: #0b0a0f;
    color: #f8fafc;
    padding: 28px 32px;
    border-radius: 14px;
    box-shadow: 0 15px 60px rgba(0, 0, 0, 0.6);
    border: 1px solid rgba(0, 255, 255, 0.16);
    text-align: center;
    min-width: 260px;
}
.loader-ring {
    position: relative;
    width: 140px;
    height: 140px;
    margin: 0 auto;
}
.loader-ring::before {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 50%;
    border: 10px solid #0dcaf0;
    border-top-color: transparent;
    border-left-color: #06bcee;
    border-right-color: #2ce6a0;
    animation: ring-spin 1.1s linear infinite;
}
.loader-ring::after {
    content: '';
    position: absolute;
    inset: 18px;
    border-radius: 50%;
    background: radial-gradient(circle at 30% 30%, #122033 0%, #0b0a0f 55%);
    box-shadow: inset 0 0 25px rgba(0, 0, 0, 0.7);
}
@keyframes ring-spin {
    to { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block content %}
<h1 class="mb-4"><i class="fas fa-folder-open"></i> All Projects</h1>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card card-stat shadow" data-filter="all">
            <div class="card-body text-center">
                <h3 class="text-primary">{{ total_jobs }}</h3>
                <p class="mb-0">Total Jobs</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card card-stat shadow" data-filter="pending">
            <div class="card-body text-center">
                <h3 class="text-warning">{{ pending_jobs }}</h3>
                <p class="mb-0">Total Pending Jobs</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card card-stat shadow">
            <div class="card-body text-center">
                <h3 class="text-success">₹{{ total_amount|floatformat:2 }}</h3>
                <p class="mb-0">Total Amount</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <a href="?filter=rework" class="text-decoration-none">
            <div class="card card-stat shadow" data-filter="rework">
                <div class="card-body text-center">
                    <h3 class="text-info">{{ total_reworks }}</h3>
                    <p class="mb-0">Total Reworks</p>
                </div>
            </div>
        </a>
    </div>
</div>

<!-- Filter/Search -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="row g-3">
            <input type="hidden" name="filter" value="{{ filter_type }}">
            <div class="col-md-3">
                <label class="form-label">Search</label>
                <input type="text" name="search" value="{{ filter_params.search }}" class="form-control" placeholder="Job ID, topic, etc.">
            </div>
            <div class="col-md-3">
                <label class="form-label">Status</label>
                <select name="status" class="form-select">
                    <option value="">All Status</option>
                    {% for value,label in status_choices %}
                        <option value="{{ value }}" {% if filter_params.status == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Sub Category</label>
                <input type="text" name="subcategory" value="{{ filter_params.subcategory }}" class="form-control" placeholder="Sub category keywords">
            </div>
            <div class="col-md-3">
                <label class="form-label">Date Field</label>
                <select name="date_field" class="form-select">
                    <option value="expected" {% if filter_params.date_field == 'expected' %}selected{% endif %}>Expected Deadline</option>
                    <option value="strict" {% if filter_params.date_field == 'strict' %}selected{% endif %}>Strict Deadline</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Start Date</label>
                <input type="date" name="date_from" value="{{ filter_params.date_from }}" class="form-control">
            </div>
            <div class="col-md-3">
                <label class="form-label">End Date</label>
                <input type="date" name="date_to" value="{{ filter_params.date_to }}" class="form-control">
            </div>
            <div class="col-md-3 d-flex gap-2 align-items-end">
                <button type="submit" class="btn btn-primary w-100">Apply Filters</button>
                <a href="{% url 'marketing:all_projects' %}" class="btn btn-secondary w-100">Reset</a>
            </div>
        </form>
    </div>
</div>

<!-- Jobs Table -->
<div class="card shadow">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>SL NO</th>
                        <th>Job ID</th>
                        <th>System ID</th>
                        <th>Amount</th>
                        <th>Expected Deadline</th>
                        <th>Strict Deadline</th>
                        <th>View Job</th>
                        <th>Job Summary</th>
                        <th>Job Structure</th>
                        <th>Content</th>
                        <th>Referencing</th>
                        <th>Plag Report</th>
                        <th>AI Report</th>
                        <th>Full Content</th>
                        <th>Action</th>
                        <th>Rework</th>
                    </tr>
                </thead>
                <tbody>
                    {% for job in jobs %}
                    <tr>
                        <td>
                            {% if page_obj.paginator.count %}
                                {{ forloop.counter0|add:page_obj.start_index }}
                            {% else %}
                                {{ forloop.counter }}
                            {% endif %}
                        </td>
                        <td>{{ job.job_id }}</td>
                        <td>{{ job.system_id }}</td>
                        <td>₹{{ job.amount }}</td>
                        <td>{{ job.expected_deadline|date:"M d, Y H:i" }}</td>
                        <td>{{ job.strict_deadline|date:"M d, Y H:i" }}</td>
                        <td>
                            <a href="{% url 'jobs:job_detail' job.id %}" class="btn btn-sm btn-info">
                                <i class="fas fa-eye"></i> View
                            </a>
                        </td>
                        <td>
                            {% with summary=job.summary_obj %}
                                {% if summary %}
                                    <div class="d-flex flex-column gap-1">
                                        <span class="badge bg-success text-white">Generated</span>
                                        <button
                                            class="btn btn-sm {% if job.can_view_generated %}btn-success{% else %}btn-outline-secondary{% endif %}"
                                            {% if job.can_view_generated %}onclick="viewContent({{ job.id }}, 'summary')"{% else %}disabled{% endif %}
                                        >
                                            <i class="fas fa-eye"></i> View
                                        </button>
                                    </div>
                                {% else %}
                                    <form method="post" action="{% url 'marketing:run_pipeline' job.job_id %}">
                                        {% csrf_token %}
                                        <button class="btn btn-sm btn-primary" {% if not job.can_run_pipeline %}disabled title="Generation limit reached or job in progress"{% endif %}>Generate</button>
                                    </form>
                                    <button class="btn btn-sm btn-outline-secondary mt-1" disabled>
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                {% endif %}
                            {% endwith %}
                        </td>
                        <td>
                            {% with structure=job.structure_obj %}
                                {% if structure %}
                                    <div class="d-flex flex-column gap-1">
                                        <span class="badge bg-success text-white">Generated</span>
                                        <button
                                            class="btn btn-sm {% if job.can_view_generated %}btn-success{% else %}btn-outline-secondary{% endif %}"
                                            {% if job.can_view_generated %}onclick="viewContent({{ job.id }}, 'structure')"{% else %}disabled{% endif %}
                                        >
                                            <i class="fas fa-eye"></i> View
                                        </button>
                                    </div>
                                {% else %}
                                    <form method="post" action="{% url 'marketing:run_pipeline' job.job_id %}">
                                        {% csrf_token %}
                                        <button class="btn btn-sm btn-primary" {% if not job.can_run_pipeline %}disabled title="Generation limit reached or job in progress"{% endif %}>Generate</button>
                                    </form>
                                    <button class="btn btn-sm btn-outline-secondary mt-1" disabled>
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                {% endif %}
                            {% endwith %}
                        </td>
                        <td>
                            {% with content=job.content_obj %}
                                {% if content %}
                                    <div class="d-flex flex-column gap-1">
                                        <span class="badge bg-success text-white">Generated</span>
                                        <button
                                            class="btn btn-sm {% if job.can_view_generated %}btn-success{% else %}btn-outline-secondary{% endif %}"
                                            {% if job.can_view_generated %}onclick="viewContent({{ job.id }}, 'content')"{% else %}disabled{% endif %}
                                        >
                                            <i class="fas fa-eye"></i> View
                                        </button>
                                    </div>
                                {% else %}
                                    <form method="post" action="{% url 'marketing:run_pipeline' job.job_id %}">
                                        {% csrf_token %}
                                        <button class="btn btn-sm btn-primary" {% if not job.can_run_pipeline %}disabled title="Generation limit reached or job in progress"{% endif %}>Generate</button>
                                    </form>
                                    <button class="btn btn-sm btn-outline-secondary mt-1" disabled>
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                {% endif %}
                            {% endwith %}
                        </td>
                        <td>
                            {% with references=job.references_obj %}
                                {% if references %}
                                    <div class="d-flex flex-column gap-1">
                                        <span class="badge bg-success text-white">Generated</span>
                                        <button
                                            class="btn btn-sm {% if job.can_view_generated %}btn-success{% else %}btn-outline-secondary{% endif %}"
                                            {% if job.can_view_generated %}onclick="viewContent({{ job.id }}, 'references')"{% else %}disabled{% endif %}
                                        >
                                            <i class="fas fa-eye"></i> View
                                        </button>
                                    </div>
                                {% else %}
                                    <form method="post" action="{% url 'marketing:run_pipeline' job.job_id %}">
                                        {% csrf_token %}
                                        <button class="btn btn-sm btn-primary" {% if not job.can_run_pipeline %}disabled title="Generation limit reached or job in progress"{% endif %}>Generate</button>
                                    </form>
                                    <button class="btn btn-sm btn-outline-secondary mt-1" disabled>
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                {% endif %}
                            {% endwith %}
                        </td>
                        <td>
                            {% with plag=job.plag_report_obj %}
                                {% if plag %}
                                    <div class="d-flex flex-column gap-1">
                                        <span class="badge bg-success text-white">Generated</span>
                                        <button
                                            class="btn btn-sm {% if job.can_view_generated %}btn-success{% else %}btn-outline-secondary{% endif %}"
                                            {% if job.can_view_generated %}onclick="viewContent({{ job.id }}, 'plag_report')"{% else %}disabled{% endif %}
                                        >
                                            <i class="fas fa-eye"></i> View
                                        </button>
                                    </div>
                                {% else %}
                                    <form method="post" action="{% url 'marketing:run_pipeline' job.job_id %}">
                                        {% csrf_token %}
                                        <button class="btn btn-sm btn-primary" {% if not job.can_run_pipeline %}disabled title="Generation limit reached or job in progress"{% endif %}>Generate</button>
                                    </form>
                                    <button class="btn btn-sm btn-outline-secondary mt-1" disabled>
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                {% endif %}
                            {% endwith %}
                        </td>
                        <td>
                            {% with ai=job.ai_report_obj %}
                                {% if ai %}
                                    <div class="d-flex flex-column gap-1">
                                        <span class="badge bg-success text-white">Generated</span>
                                        <button
                                            class="btn btn-sm {% if job.can_view_generated %}btn-success{% else %}btn-outline-secondary{% endif %}"
                                            {% if job.can_view_generated %}onclick="viewContent({{ job.id }}, 'ai_report')"{% else %}disabled{% endif %}
                                        >
                                            <i class="fas fa-eye"></i> View
                                        </button>
                                    </div>
                                {% else %}
                                    <form method="post" action="{% url 'marketing:run_pipeline' job.job_id %}">
                                        {% csrf_token %}
                                        <button class="btn btn-sm btn-primary" {% if not job.can_run_pipeline %}disabled title="Generation limit reached or job in progress"{% endif %}>Generate</button>
                                    </form>
                                    <button class="btn btn-sm btn-outline-secondary mt-1" disabled>
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                {% endif %}
                            {% endwith %}
                        </td>
                        <td>
                            {% with full=job.full_content_obj %}
                                {% if full %}
                                    <div class="d-flex flex-column gap-1">
                                        {% if full.is_approved %}
                                            <span class="badge bg-success text-white">Approved</span>
                                        {% else %}
                                            <span class="badge bg-warning text-dark">Awaiting SuperAdmin approval</span>
                                        {% endif %}
                                        <button
                                            class="btn btn-sm {% if job.can_view_generated %}btn-success{% else %}btn-outline-secondary{% endif %}"
                                            {% if job.can_view_generated %}onclick="viewContent({{ job.id }}, 'full_content')"{% else %}disabled{% endif %}
                                        >
                                            <i class="fas fa-eye"></i> View
                                        </button>
                                    </div>
                                {% else %}
                                    <form method="post" action="{% url 'marketing:run_pipeline' job.job_id %}">
                                        {% csrf_token %}
                                        <button class="btn btn-sm btn-primary" {% if not job.can_run_pipeline %}disabled title="Generation limit reached or job in progress"{% endif %}>Generate</button>
                                    </form>
                                    <button class="btn btn-sm btn-outline-secondary mt-1" disabled>
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                {% endif %}
                            {% endwith %}
                        </td>
                        <td>
                            <div class="d-flex flex-column gap-2">
                                <div class="small {% if job.generation_used >= job.generation_limit %}text-danger{% else %}text-muted{% endif %}">
                                    Regenerations used: {{ job.generation_used|default:0 }}/{{ job.generation_limit }}
                                </div>
                                <div class="d-flex flex-wrap align-items-center gap-2">
                                    <form method="post" action="{% url 'marketing:run_pipeline' job.job_id %}">
                                        {% csrf_token %}
                                        <button
                                            class="btn btn-sm btn-primary"
                                            style="min-width: 90px; padding: 4px 8px;"
                                            {% if not job.can_run_pipeline %}
                                                disabled
                                                title="{% if job.generation_used >= job.generation_limit %}Regeneration limit reached{% else %}Pipeline currently running or job locked{% endif %}"
                                            {% endif %}
                                        >
                                            <i class="fas fa-magic me-1"></i> Run
                                        </button>
                                    </form>
                                    <form method="post" action="{% url 'marketing:upload_payment_slip' job.job_id %}" enctype="multipart/form-data" class="d-flex align-items-center gap-1 flex-wrap">
                                        {% csrf_token %}
                                        <input
                                            type="file"
                                            name="payment_slip"
                                            accept=".png,.jpg,.jpeg,.pdf"
                                            class="form-control form-control-sm"
                                            style="max-width: 110px; padding: 2px 4px;"
                                            {% if not job.pipeline_completed or job.payment_slip or not allow_payment_slip %}disabled{% endif %}
                                            required
                                        >
                                        <button
                                            class="btn btn-sm btn-outline-success"
                                            style="padding: 4px 8px; font-size: 12px;"
                                            {% if not job.pipeline_completed or job.payment_slip or not allow_payment_slip %}disabled title="Payment slip uploads disabled by Super Admin or pipeline not ready"{% endif %}
                                        >
                                            <i class="fas fa-upload"></i>
                                        </button>
                                    </form>
                                    {% if job.payment_slip %}
                                        <a href="{{ job.payment_slip.url }}" target="_blank" class="text-decoration-none small text-success">
                                            <i class="fas fa-file-image me-1"></i> Slip
                                        </a>
                                    {% endif %}
                                    {% if job.status == 'PENDING' %}
                                        <div class="d-flex gap-1">
                                            <a href="{% url 'jobs:edit_job' job.id %}" class="btn btn-sm btn-outline-primary" title="Edit Job">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <form method="post" action="{% url 'jobs:delete_job' job.id %}" onsubmit="return confirm('Delete this job?');">
                                                {% csrf_token %}
                                                <button class="btn btn-sm btn-outline-danger" title="Delete Job">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    {% else %}
                                        <div class="d-flex gap-1">
                                            <button class="btn btn-sm btn-outline-secondary" disabled title="Edit disabled">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-secondary" disabled title="Delete disabled">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="text-muted small mb-2">{{ job.rework_count }}/{{ rework_limit }} used</div>
                            <div class="d-flex gap-2 flex-wrap">
                                <button
                                    type="button"
                                    class="btn btn-sm btn-outline-warning btn-request-rework"
                                    data-post-url="{% url 'marketing:request_rework' job.job_id %}"
                                    data-job-id="{{ job.job_id }}"
                                    data-system-id="{{ job.system_id }}"
                                    {% if job.rework_count >= rework_limit or not job.can_request_rework %}disabled{% endif %}
                                    title="Request Rework"
                                >
                                    <i class="fas fa-undo"></i>
                                </button>
                                <a
                                    href="{% url 'marketing:job_rework_history' job.job_id %}"
                                    class="btn btn-sm btn-outline-info {% if not job.rework_count %}disabled{% endif %}"
                                    {% if not job.rework_count %}tabindex="-1" aria-disabled="true"{% endif %}
                                    title="View Reworks"
                                >
                                    <i class="fas fa-eye"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="16" class="text-center text-muted">No jobs found</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div class="card-footer bg-light d-flex flex-wrap justify-content-between align-items-center gap-3">
        <div class="text-muted">
            Total Count: {{ filtered_total }} | {{ per_page }} Records Per Page
        </div>
        <div class="d-flex align-items-center gap-2">
            {% if page_obj.has_previous %}
                <a class="btn btn-sm btn-outline-secondary" href="?{% if pagination_query %}{{ pagination_query }}&{% endif %}page=1"><i class="fas fa-angle-double-left"></i></a>
                <a class="btn btn-sm btn-outline-secondary" href="?{% if pagination_query %}{{ pagination_query }}&{% endif %}page={{ page_obj.previous_page_number }}"><i class="fas fa-angle-left"></i></a>
            {% else %}
                <button class="btn btn-sm btn-outline-secondary" disabled><i class="fas fa-angle-double-left"></i></button>
                <button class="btn btn-sm btn-outline-secondary" disabled><i class="fas fa-angle-left"></i></button>
            {% endif %}
            {% if page_obj.paginator.count %}
                <span class="fw-semibold">{{ page_obj.start_index }}-{{ page_obj.end_index }}</span>
            {% else %}
                <span class="fw-semibold">0-0</span>
            {% endif %}
            {% if page_obj.has_next %}
                <a class="btn btn-sm btn-outline-secondary" href="?{% if pagination_query %}{{ pagination_query }}&{% endif %}page={{ page_obj.next_page_number }}"><i class="fas fa-angle-right"></i></a>
                <a class="btn btn-sm btn-outline-secondary" href="?{% if pagination_query %}{{ pagination_query }}&{% endif %}page={{ page_obj.paginator.num_pages }}"><i class="fas fa-angle-double-right"></i></a>
            {% else %}
                <button class="btn btn-sm btn-outline-secondary" disabled><i class="fas fa-angle-right"></i></button>
                <button class="btn btn-sm btn-outline-secondary" disabled><i class="fas fa-angle-double-right"></i></button>
            {% endif %}
        </div>
    </div>
</div>

<!-- View Content Modal -->
<div class="modal fade" id="contentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">View Content</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="contentBody">
                <p>Loading...</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="copyContent()">
                    <i class="fas fa-copy"></i> Copy
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Rework Modal -->
<div class="modal fade" id="reworkModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Request Rework</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" id="reworkForm" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Job ID</label>
                        <input type="text" class="form-control" id="reworkJobId" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">System ID</label>
                        <input type="text" class="form-control" id="reworkSystemId" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Comment</label>
                    <textarea name="reason" class="form-control" rows="4" required placeholder="Explain what needs to be fixed."></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Expected Deadline</label>
                        <input type="datetime-local" name="expected_deadline" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Attachment</label>
                        <input type="file" name="attachment" class="form-control" accept=".doc,.docx,.pdf,.png,.jpg,.jpeg,.pptx,.csv,.xlsx,.xls">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-undo me-1"></i> Submit Rework
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% comment %} <!-- Confirm Run Modal -->
<div class="modal fade" id="confirmSubmitModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Submit</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-0">Submit this form?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" data-confirm="yes">Yes, continue</button>
            </div>
        </div>
    </div>
</div> {% endcomment %}

<div id="generationOverlay" class="generation-overlay" aria-hidden="true">
    <div class="generation-modal">
        <div class="loader-ring" role="status" aria-label="Generating content"></div>
        <div class="mt-3 fw-semibold">Generating content</div>
        <p class="text-muted small mb-0">Please wait while we create your deliverables.</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function viewContent(jobId, contentType) {
    fetch(`/ai/view-content/${jobId}/${contentType}/`)
        .then(async response => {
            const data = await response.json();
            if (!response.ok || data.error) {
                alert(data.error || 'Content is locked or unavailable.');
                return null;
            }
            return data;
        })
        .then(data => {
            if (!data) return;
            let html = '';
            if (data.content) {
                html = `<pre style="white-space: pre-wrap;">${data.content}</pre>`;
            } else {
                html = '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
            }
            document.getElementById('contentBody').innerHTML = html;
            new bootstrap.Modal(document.getElementById('contentModal')).show();
        })
        .catch(error => {
            alert('Error loading content');
        });
}

function copyContent() {
    const content = document.getElementById('contentBody').innerText;
    navigator.clipboard.writeText(content).then(() => {
        alert('Content copied to clipboard!');
    });
}

document.addEventListener('DOMContentLoaded', function() {
    const modalElement = document.getElementById('reworkModal');
    if (modalElement) {
        const modal = new bootstrap.Modal(modalElement);
        const form = document.getElementById('reworkForm');
        const jobInput = document.getElementById('reworkJobId');
        const systemInput = document.getElementById('reworkSystemId');

        document.querySelectorAll('.btn-request-rework').forEach(button => {
            button.addEventListener('click', () => {
                const actionUrl = button.dataset.postUrl;
                const jobId = button.dataset.jobId;
                const systemId = button.dataset.systemId;
                form.action = actionUrl;
                jobInput.value = jobId;
                systemInput.value = systemId;
                form.reset();
                jobInput.value = jobId;
                systemInput.value = systemId;
                modal.show();
            });
        });
    }

    const overlay = document.getElementById('generationOverlay');
    const showGenerationOverlay = () => {
        if (overlay) overlay.classList.add('active');
    };

    const confirmModalEls = Array.from(document.querySelectorAll('#confirmSubmitModal'));
    if (confirmModalEls.length > 1) {
        confirmModalEls.slice(1).forEach(el => el.remove());
    }
    const confirmModalEl = confirmModalEls[0] || null;
    const confirmModal = confirmModalEl ? new bootstrap.Modal(confirmModalEl) : null;
    const confirmBtn = confirmModalEl ? confirmModalEl.querySelector('[data-confirm="yes"]') : null;
    let pendingForm = null;

    const proceedSubmit = (formEl) => {
        formEl.dataset.confirmed = 'true';
        showGenerationOverlay();
        const submitBtn = formEl.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> Generating...';
        }
        formEl.submit();
    };

    if (confirmBtn && confirmModal) {
        confirmBtn.addEventListener('click', () => {
            if (pendingForm) {
                confirmModal.hide();
                proceedSubmit(pendingForm);
                pendingForm = null;
            }
        });
    }

    document.querySelectorAll('form[action*="run-pipeline"]').forEach(formEl => {
        formEl.addEventListener('submit', (evt) => {
            if (formEl.dataset.confirmed === 'true') {
                showGenerationOverlay();
                return;
            }
            evt.preventDefault();
            pendingForm = formEl;
            if (confirmModal) {
                confirmModal.show();
            } else {
                proceedSubmit(formEl);
            }
        });
    });
});
</script>
{% endblock %}
