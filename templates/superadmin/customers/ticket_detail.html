{% extends 'base.html' %}
{% block content %}
<h2>Customer Ticket</h2>
<p class="text-muted">Full details for ticket {{ ticket.ticket_id }}.</p>

<div class="card shadow-sm mb-3">
  <div class="card-body d-flex justify-content-between align-items-start">
    <div>
      <div class="fw-semibold">Ticket ID: {{ ticket.ticket_id }}</div>
      <div class="text-muted small">Status: {{ ticket.status }} | Priority: {{ ticket.priority }}</div>
      <div class="text-muted small">Created: {{ ticket.created_at|date:"Y-m-d H:i" }} | Updated: {{ ticket.updated_at|date:"Y-m-d H:i" }}</div>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary btn-sm" href="{% url 'superadmin:customer_tickets' %}">Back</a>
      <a class="btn btn-primary btn-sm" href="{% if edit_mode %}{% url 'superadmin:customer_ticket_detail' ticket.ticket_id %}{% else %}?edit=1{% endif %}">
        {% if edit_mode %}Cancel Edit{% else %}Edit{% endif %}
      </a>
    </div>
  </div>
</div>

<div class="card shadow-sm mb-3">
  <div class="card-body">
    <h5 class="mb-3">Customer</h5>
    <div class="row g-3">
      <div class="col-md-6">
        <div class="fw-semibold">Name</div>
        <div class="text-muted">{{ ticket.customer_name|default:'N/A' }}</div>
      </div>
      <div class="col-md-6">
        <div class="fw-semibold">Customer ID</div>
        <div class="text-muted">{{ ticket.customer_id|default:'N/A' }}</div>
      </div>
      <div class="col-md-6">
        <div class="fw-semibold">Email</div>
        <div class="text-muted">{{ ticket.user.email|default:'' }}</div>
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm mb-3">
  <div class="card-body">
    <h5 class="mb-3">Ticket Details</h5>
    <div class="row g-3">
      <div class="col-md-6">
        <div class="fw-semibold">Subject</div>
        <div class="text-muted">{{ ticket.subject }}</div>
      </div>
      <div class="col-md-6">
        <div class="fw-semibold">Category</div>
        <div class="text-muted">{{ ticket.category|default:'-' }}</div>
      </div>
      <div class="col-md-6">
        <div class="fw-semibold">Status</div>
        <div class="text-muted">{{ ticket.status }}</div>
      </div>
      <div class="col-md-6">
        <div class="fw-semibold">Priority</div>
        <div class="text-muted">{{ ticket.priority }}</div>
      </div>
      <div class="col-12">
        <div class="fw-semibold">Description</div>
        <pre class="bg-light p-3 rounded" style="white-space: pre-wrap;">{{ ticket.description }}</pre>
      </div>
      <div class="col-12">
        <div class="fw-semibold">Attachment</div>
        {% if ticket.attachment %}
          <a class="btn btn-sm btn-outline-primary" href="{{ ticket.attachment.url }}" target="_blank">Download / View</a>
        {% else %}
          <div class="text-muted">No attachment provided.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{% if edit_mode %}
<div class="card shadow-sm">
  <div class="card-body">
    <h5 class="mb-3">Super Admin Update</h5>
    <form method="post">
      {% csrf_token %}
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Status</label>
          <select class="form-select" name="status">
            {% for code,label in status_choices %}
            <option value="{{ code }}" {% if ticket.status == code %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Priority</label>
          <select class="form-select" name="priority">
            {% for code,label in priority_choices %}
            <option value="{{ code }}" {% if ticket.priority == code %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-12">
          <label class="form-label">Admin Notes</label>
          <textarea class="form-control" name="admin_note" rows="3">{{ admin_note }}</textarea>
        </div>
      </div>
      <div class="d-flex gap-2 mt-3">
        <button class="btn btn-success" type="submit">Save</button>
        <a class="btn btn-outline-secondary" href="{% url 'superadmin:customer_ticket_detail' ticket.ticket_id %}">Cancel</a>
      </div>
    </form>
  </div>
</div>
{% else %}
<div class="card shadow-sm">
  <div class="card-body">
    <h5 class="mb-3">Admin Notes</h5>
    <div class="bg-light p-3 rounded" style="white-space: pre-wrap;">{{ ticket.admin_notes|default:"No admin notes." }}</div>
  </div>
</div>
{% endif %}
{% endblock %}
