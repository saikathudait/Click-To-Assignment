{% extends 'base.html' %}

{% block title %}Rework Detail{% endblock %}

{% block content %}
<div class="mb-4 d-flex justify-content-between align-items-center">
    <div>
        <h2 class="mb-1"><i class="fas fa-info-circle"></i> Rework Detail</h2>
        <p class="text-muted mb-0">Review the submitted information before completing the rework.</p>
    </div>
    <a href="{% url 'superadmin:rework_list' %}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left"></i> Back to Reworks
    </a>
</div>

<div class="row g-4">
    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Job Info</h5>
            </div>
            <div class="card-body">
                <p><strong>Rework ID:</strong> {{ rework.rework_id|default:rework.assign_rework_id }}</p>
                <p><strong>Job ID:</strong> {{ rework.job.job_id }}</p>
                <p><strong>System ID:</strong> {{ rework.job.system_id }}</p>
                <p><strong>Amount:</strong> â‚¹{{ rework.job.amount|default:0|floatformat:2 }}</p>
                <p><strong>Requested By:</strong> {{ rework.requested_by.get_full_name|default:rework.requested_by.email }}</p>
                <p><strong>Submitted On:</strong> {{ rework.created_at|date:"M d, Y H:i" }}</p>
                <p><strong>Expected Deadline:</strong> {{ rework.expected_deadline|date:"M d, Y H:i" }}</p>
                <p><strong>Strict Deadline:</strong> {{ rework.job.strict_deadline|date:"M d, Y H:i" }}</p>
                <p class="mb-1"><strong>Instruction:</strong></p>
                <div class="p-2 bg-light rounded border" style="white-space: pre-wrap;">
                    {{ rework.job.instruction }}
                </div>
                {% if rework.job.attachments.all %}
                    <p class="mt-2 mb-1"><strong>Attachments:</strong></p>
                    <ul class="list-unstyled mb-2">
                        {% for attachment in rework.job.attachments.all %}
                            <li class="mb-1">
                                <i class="fas fa-file me-1"></i>
                                <a href="{{ attachment.file.url }}" target="_blank">{{ attachment.filename }}</a>
                                <small class="text-muted">({{ attachment.file_size|filesizeformat }})</small>
                            </li>
                        {% empty %}
                            <li class="text-muted">No attachments.</li>
                        {% endfor %}
                    </ul>
                {% endif %}
                <p><strong>Status:</strong>
                    {% if rework.status == 'PENDING' %}
                        <span class="badge bg-warning text-dark">Pending</span>
                    {% elif rework.status == 'APPROVED' %}
                        <span class="badge bg-success">Completed</span>
                    {% else %}
                        <span class="badge bg-danger">Rejected</span>
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <h5 class="mb-0">Rework Notes</h5>
            </div>
            <div class="card-body">
                <p>{{ rework.reason|linebreaks }}</p>
                {% if rework.attachment %}
                    <p>
                        <strong>Attachment:</strong>
                        <a href="{{ rework.attachment.url }}" class="btn btn-link" target="_blank">
                            <i class="fas fa-download"></i> Download
                        </a>
                    </p>
                {% endif %}
            </div>
        </div>
    </div>
    {% if full_content %}
    <div class="col-md-6">
        <div class="card shadow-sm mt-3">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Full Content</h5>
                <div class="d-flex gap-2">
                    {% if full_content.final_word_count %}
                        <span class="badge bg-light text-dark">Words: {{ full_content.final_word_count }}</span>
                    {% endif %}
                    {% if full_content.content_file %}
                        <a href="{{ full_content.content_file.url }}" class="btn btn-sm btn-light" target="_blank">
                            <i class="fas fa-download"></i> Download
                        </a>
                    {% endif %}
                    <button class="btn btn-sm btn-outline-light" type="button" data-bs-toggle="modal" data-bs-target="#fullContentModal">
                        <i class="fas fa-eye"></i> View
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Full Content Modal -->
<div class="modal fade" id="fullContentModal" tabindex="-1" aria-labelledby="fullContentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="fullContentModalLabel">Full Content - {{ rework.job.job_id }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="white-space: pre-wrap;">
        {% if full_content.content_with_citations %}
            {{ full_content.content_with_citations }}
        {% elif full_content.content_file %}
            <p class="mb-2 text-muted">Full content is available as a file. Use the download button in the card above.</p>
        {% else %}
            <p class="text-muted mb-0">No full content available.</p>
        {% endif %}
      </div>
      <div class="modal-footer">
        {% if full_content.content_file %}
            <a href="{{ full_content.content_file.url }}" class="btn btn-outline-primary" target="_blank">
                <i class="fas fa-download"></i> Download File
            </a>
        {% endif %}
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endif %}

{% comment %}
Rework workflow cards: purely UI/stateful (localStorage) to let Super Admin generate/view/regenerate/approve
summary + rework content for this job's rework ID. No backend mutation is performed here.
{% endcomment %}
<div class="row g-3 mt-4"
     data-summary-generate-url="{% url 'superadmin:rework_generate_summary' rework.pk %}"
     data-rework-generate-url="{% url 'superadmin:rework_generate_rework' rework.pk %}"
     data-summary-approve-url="{% url 'superadmin:rework_approve_summary' rework.pk %}"
     data-rework-approve-url="{% url 'superadmin:rework_approve_rework' rework.pk %}">
    <div class="col-lg-6">
        <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Rework Summary</h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-primary" type="button" data-rework-action="generate-summary">Generate</button>
            <button class="btn btn-sm btn-outline-secondary" type="button" data-rework-action="view-summary">View</button>
                    <button class="btn btn-sm btn-warning" type="button" data-rework-action="regenerate-summary">Regenerate</button>
                    <button class="btn btn-sm btn-success" type="button" data-rework-action="approve-summary">Approve</button>
                </div>
            </div>
            <div class="card-body">
                <small class="text-muted d-block mb-2">Up to 3 regenerations allowed.</small>
                <div class="border rounded p-3 bg-light position-relative" style="min-height: 120px; position: relative;" id="summaryContainer">
                    <div id="summaryContent" style="white-space: pre-wrap; display: none;"></div>
                    <div class="text-muted small" id="summaryPlaceholder">Click Generate to create a rework summary.</div>
                    <div id="summarySpinner" class="position-absolute top-50 start-50 translate-middle text-center" style="display: none; z-index: 2;">
                        <div class="spinner-border text-primary" role="status"></div>
                        <div class="small text-muted mt-2 bg-white px-2 py-1 rounded shadow-sm">Generating summary...</div>
                    </div>
                    <div class="position-absolute top-0 start-0 w-100 h-100 bg-white opacity-50" id="summaryOverlay" style="display: none; z-index:1;"></div>
                </div>
                <div class="mt-2 d-flex justify-content-between align-items-center">
                    <span class="badge bg-light text-dark" id="summaryStatus">Status: Draft</span>
                    <small class="text-muted" id="summaryCounter"></small>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Make Rework</h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-primary" type="button" data-rework-action="generate-rework">Generate</button>
            <button class="btn btn-sm btn-outline-secondary" type="button" data-rework-action="view-rework">View</button>
                    <button class="btn btn-sm btn-warning" type="button" data-rework-action="regenerate-rework">Regenerate</button>
                    <button class="btn btn-sm btn-success" type="button" data-rework-action="approve-rework">Approve</button>
                </div>
            </div>
            <div class="card-body">
                <small class="text-muted d-block mb-2">Up to 3 regenerations allowed.</small>
                <div class="border rounded p-3 bg-light position-relative" style="min-height: 120px; position: relative;" id="reworkContainer">
                    <div id="reworkContent" style="white-space: pre-wrap; display: none;"></div>
                    <div class="text-muted small" id="reworkPlaceholder">Generate after the summary is approved.</div>
                    <div id="reworkSpinner" class="position-absolute top-50 start-50 translate-middle text-center" style="display: none; z-index: 2;">
                        <div class="spinner-border text-warning" role="status"></div>
                        <div class="small text-muted mt-2 bg-white px-2 py-1 rounded shadow-sm">Generating rework...</div>
                    </div>
                    <div class="position-absolute top-0 start-0 w-100 h-100 bg-white opacity-50" id="reworkOverlay" style="display: none; z-index:1;"></div>
                </div>
                <div class="mt-2 d-flex justify-content-between align-items-center">
                    <span class="badge bg-light text-dark" id="reworkStatus">Status: Draft</span>
                    <small class="text-muted" id="reworkCounter"></small>
                </div>
                <div class="mt-3 text-end">
                    <button class="btn btn-sm btn-info" type="button" data-rework-action="view-reworked-content">
                        <i class="fas fa-eye"></i> View Reworked Content
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{% if rework.status == 'PENDING' %}
<div class="card shadow-sm mt-4">
    <div class="card-header bg-success text-white">
        <h5 class="mb-0">Complete Rework</h5>
    </div>
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="complete">
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label">Response Notes (optional)</label>
                <textarea name="response_notes" class="form-control" rows="4" placeholder="Add internal notes if needed."></textarea>
            </div>
        </div>
        <div class="card-footer text-end">
            <button type="submit" class="btn btn-success">
                <i class="fas fa-check"></i> Mark as Completed
            </button>
        </div>
    </form>
</div>
{% else %}
<div class="alert alert-info mt-4">
    This rework was handled on {{ rework.handled_at|date:"M d, Y H:i" }} by {{ rework.handled_by.get_full_name|default:rework.handled_by.email }}.
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const initial = {{ rework_generation_json|safe }};
    const container = document.querySelector('[data-summary-generate-url]');
    const summaryContent = document.getElementById('summaryContent');
    const reworkContent = document.getElementById('reworkContent');
    const summaryStatusEl = document.getElementById('summaryStatus');
    const reworkStatusEl = document.getElementById('reworkStatus');
    const summaryCounter = document.getElementById('summaryCounter');
    const reworkCounter = document.getElementById('reworkCounter');

    function updateUI(data, type) {
        if (type === 'summary') {
            if (data.summary_text !== undefined && summaryContent) {
                summaryContent.textContent = data.summary_text || 'No content';
                summaryContent.style.display = 'none';
                const ph = document.getElementById('summaryPlaceholder');
                if (ph) ph.textContent = 'Generated. Click View to open.';
            }
            if (data.summary_status && summaryStatusEl) summaryStatusEl.textContent = `Status: ${data.summary_status}`;
            if (data.summary_regen_count !== undefined && summaryCounter) summaryCounter.textContent = `Regenerated: ${data.summary_regen_count}/${initial.summary_limit}`;
        }
        if (type === 'rework') {
            if (data.rework_text !== undefined && reworkContent) {
                reworkContent.textContent = data.rework_text || 'No content';
                reworkContent.style.display = 'none';
                const ph = document.getElementById('reworkPlaceholder');
                if (ph) ph.textContent = 'Generated. Click View to open.';
            }
            if (data.rework_status && reworkStatusEl) reworkStatusEl.textContent = `Status: ${data.rework_status}`;
            if (data.rework_regen_count !== undefined && reworkCounter) reworkCounter.textContent = `Regenerated: ${data.rework_regen_count}/${initial.rework_limit}`;
        }
    }

    function initUI() {
        updateUI(initial, 'summary');
        updateUI(initial, 'rework');
        if (summaryCounter) summaryCounter.textContent = `Regenerated: ${initial.summary_regen_count}/${initial.summary_limit}`;
        if (reworkCounter) reworkCounter.textContent = `Regenerated: ${initial.rework_regen_count}/${initial.rework_limit}`;
    }

    function getCSRFToken() {
        const name = 'csrftoken';
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                return decodeURIComponent(cookie.substring(name.length + 1));
            }
        }
        return '';
    }

    function showSpinner(kind, show) {
        const spinner = kind === 'summary' ? document.getElementById('summarySpinner') : document.getElementById('reworkSpinner');
        const overlay = kind === 'summary' ? document.getElementById('summaryOverlay') : document.getElementById('reworkOverlay');
        if (spinner) spinner.style.display = show ? 'block' : 'none';
        if (overlay) overlay.style.display = show ? 'block' : 'none';
    }

    async function callApi(url, kind) {
        if (kind) showSpinner(kind, true);
        const resp = await fetch(url, {
            method: 'POST',
            headers: {'X-CSRFToken': getCSRFToken()},
        });
        const data = await resp.json();
        if (kind) showSpinner(kind, false);
        if (!resp.ok) {
            throw new Error(data.error || 'Request failed');
        }
        return data;
    }

    function bindActions() {
        if (!container) return;
        container.querySelectorAll('[data-rework-action]').forEach(btn => {
            btn.addEventListener('click', async (event) => {
                event.preventDefault();
                const action = btn.getAttribute('data-rework-action');
                try {
                    if (action === 'generate-summary' || action === 'regenerate-summary') {
                        const data = await callApi(container.dataset.summaryGenerateUrl, 'summary');
                        updateUI(data, 'summary');
                    } else if (action === 'approve-summary') {
                        const data = await callApi(container.dataset.summaryApproveUrl, 'summary');
                        updateUI(data, 'summary');
                        alert('Summary approved. You can now generate rework content.');
                    } else if (action === 'view-summary') {
                        openViewer('Summary', summaryContent ? summaryContent.textContent : 'No content');
                    } else if (action === 'generate-rework' || action === 'regenerate-rework') {
                        const data = await callApi(container.dataset.reworkGenerateUrl, 'rework');
                        updateUI(data, 'rework');
                    } else if (action === 'approve-rework') {
                        const data = await callApi(container.dataset.reworkApproveUrl, 'rework');
                        updateUI(data, 'rework');
                        alert('Rework approved. You can complete the rework below.');
                    } else if (action === 'view-rework') {
                        openViewer('Rework', reworkContent ? reworkContent.textContent : 'No content');
                    } else if (action === 'view-reworked-content') {
                        openViewer('Reworked Content', reworkContent ? reworkContent.textContent : 'No content');
                    }
                } catch (err) {
                    alert(err.message || 'Error');
                }
            });
        });
    }

    function ensureViewerModal() {
        let modalEl = document.getElementById('textViewModal');
        if (modalEl) return modalEl;
        const wrapper = document.createElement('div');
        wrapper.innerHTML = `
<div class="modal fade" id="textViewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Content</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="white-space: pre-wrap;"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>`;
        document.body.appendChild(wrapper.firstElementChild);
        return document.getElementById('textViewModal');
    }

    function openViewer(title, bodyText) {
        const modalEl = ensureViewerModal();
        modalEl.querySelector('.modal-title').textContent = title;
        modalEl.querySelector('.modal-body').textContent = bodyText || 'No content';
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
    }

    initUI();
    bindActions();
});
</script>
{% endblock %}

<!-- Generic text viewer modal for summary/rework -->
<div class="modal fade" id="textViewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Content</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="white-space: pre-wrap;"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
